var search_offset=0;var search_order="title";var search_query="";function loadBook(a){clearInputs("#book_center input, #book_center textarea, #book_center select");$.ajax({url:uri+"/books/loadBook",type:"GET",dataType:"json",data:{book_id:a},async:true,success:function(b){if(b!=-1){$("#book_list").slideUp(250,procReturn(b));if($("#book_del").css("display")=="none"){$("#book_del").css("display","")}hideStatus()}else{showStatus("Error on reading book.")}},error:function(b){showStatus("Error on reading book.")}})}function delBook(){if($("#book__book_id").val()){var a=confirm("Delete This Book?");if(a){showStatus("Deleting...",false,function(){data={cls:"book",id:$("#book__book_id").val()};$.ajax({url:uri+"/svc/delete",type:"POST",dataType:"json",data:data,async:true,success:function(b){if(b!=-1){showStatus("Book Deleted!",false,function(){window.location=uri+"/books"})}else{showStatus("Error on deleting book.")}},error:function(b){showStatus("Error on deleting book.")}})})}}}function addBook(){showStatus("Creating Book",false,function(){var d=new Date();var isbn=prompt("Enter an ISBN or press Cancel");if(isbn){addByISBN(isbn)}else{var res=$.ajax({url:uri+"/svc/create",type:"POST",dataType:"json",data:{cls:"Book",data:{title:"New Book",authors:"Last, First",date_added:Math.floor(new Date().getTime()/1000),synopsis:"Add Synopsis Here"}},async:false});if(res!=-1){eval("res = "+res.responseText);showStatus("Book Created!");loadBook(res.book_id)}else{showStatus("Book Creation Failed.")}}})}function saveBook(){saveFunc=function(){var d=false;if($(".dirty_input.book").length!=0&&$("#book__book_id").val()){d=true;var c={id:$("#book__book_id").val(),cls:"book",data:{}};var b=$(".dirty_input.book");for(var a=0;a<b.length;a++){c.data[b[a].id.replace("book__","")]=$(b[a]).val()}$.ajax({url:uri+"/svc/update",type:"POST",dataType:"json",data:c,async:true,success:function(e){if(e!=-1){clearDirty("#book_center input.book, #book_center textarea.book, #book_center select.book");showStatus("Book Saved!")}else{showStatus("Error on saving book.")}},error:function(e){showStatus("Error on saving book.")}})}if($(".dirty_input.book_marketing_info").length!=0){d=true;if($("#book__book_marketing_info_id").val()){var c={id:$("#book__book_marketing_info_id").val(),cls:"BookMarketingInfo",data:{}};var b=$(".dirty_input.book_marketing_info");for(var a=0;a<b.length;a++){c.data[b[a].id.replace("book_marketing_info__","")]=$(b[a]).val()}$.ajax({url:uri+"/svc/update",type:"POST",dataType:"json",data:c,async:true,success:function(e){if(e!=-1){clearDirty("#book_center input.book_marketing_info, #book_center textarea.book_marketing_info, #book_center select.book_marketing_info");showStatus("Book Saved!")}else{showStatus("Error on saving book.")}},error:function(e){showStatus("Error on saving book.")}})}else{var c={cls:"BookMarketingInfo",data:{}};var b=$(".dirty_input.book_marketing_info");for(var a=0;a<b.length;a++){c.data[b[a].id.replace("book_marketing_info__","")]=$(b[a]).val()}$.ajax({url:uri+"/svc/create",type:"POST",dataType:"json",data:c,async:true,success:function(e){if(e!=-1){clearDirty("#book_center input.book_marketing_info, #book_center textarea.book_marketing_info, #book_center select.book_marketing_info");$.ajax({url:uri+"/svc/update",async:true,type:"POST",dataType:"json",data:{id:$("#book__book_id").val(),cls:"book",data:{book_marketing_info_id:e.book_marketing_info_id}}});showStatus("Book Saved!")}else{showStatus("Create Failed...")}},error:function(e){showStatus("Create Failed...")}})}}if($(".dirty_input.extra_book_marketing_info").length!=0){d=true;if($("#book__extra_book_marketing_info_id").val()){var c={id:$("#book__extra_book_marketing_info_id").val(),cls:"BookMarketingInfo",data:{}};var b=$(".dirty_input.extra_book_marketing_info");for(var a=0;a<b.length;a++){c.data[b[a].id.replace("extra_book_marketing_info__","")]=$(b[a]).val()}$.ajax({url:uri+"/svc/update",type:"POST",dataType:"json",data:c,async:true,success:function(e){if(e!=-1){clearDirty("#book_center input.extra_book_marketing_info, #book_center textarea.extra_book_marketing_info, #book_center select.extra_book_marketing_info")}else{showStatus("Error on saving book.")}},error:function(e){showStatus("Error on saving book.")}})}else{var c={cls:"BookMarketingInfo",data:{}};var b=$(".dirty_input.extra_book_marketing_info");for(var a=0;a<b.length;a++){c.data[b[a].id.replace("extra_book_marketing_info__","")]=$(b[a]).val()}$.ajax({url:uri+"/svc/create",type:"POST",dataType:"json",data:c,async:true,success:function(e){if(e!=-1){clearDirty("#book_center input.extra_book_marketing_info, #book_center textarea.extra_book_marketing_info, #book_center select.extra_book_marketing_info");$.ajax({url:uri+"/svc/update",async:true,dataType:"json",data:{id:$("#book__book_id").val(),cls:"book",data:{extra_book_marketing_info_id:e.book_marketing_info_id}}});showStatus("Book Saved!")}else{showStatus("Create Failed...")}},error:function(e){showStatus("Create Failed...")}})}}if($(".dirty_input.book_review").length!=0){d=true;if($("#book_review__book_review_id").val()){var c={id:$("#book_review__book_review_id").val(),cls:"BookReview",data:{}};var b=$(".dirty_input.book_review");for(var a=0;a<b.length;a++){c.data[b[a].id.replace("book_review__","")]=$(b[a]).val()}$.ajax({url:uri+"/svc/update",type:"POST",dataType:"json",data:c,async:true,success:function(e){if(e!=-1){clearDirty("#book_center input.book_review");hideStatus()}else{showStatus("Error on saving book review.")}},error:function(e){showStatus("Error on saving book review.")}})}else{var c={cls:"BookReview",data:{}};var b=$(".dirty_input.book_review");for(var a=0;a<b.length;a++){c.data[b[a].id.replace("book_review__","")]=$(b[a]).val()}c.data.book_id=$("#book__book_id").val();$.ajax({url:uri+"/svc/create",type:"POST",dataType:"json",data:c,async:true,success:function(e){if(e!=-1){clearDirty("#book_center input.book_review");$.ajax({url:uri+"/svc/update",async:true,dataType:"json",data:{id:$("#book_review__book_review_id").val(),cls:"book_review",data:{book_review_id:e.book_review_id}}});showStatus("Book Review Saved!")}else{showStatus("Create Failed...")}},error:function(e){showStatus("Create Failed...")}})}}if(!d){hideStatus()}};showStatus("Saving...",false,saveFunc)}var filterTimeoutProc=false;function filterBook(){if(filterTimeoutProc!=false){clearTimeout(filterTimeoutProc)}filterTimeoutProc=setTimeout(execFilter,500)}function execFilter(b,a){if(typeof b=="undefined"){search_offset=0}else{search_offset=b}if(typeof a!="undefined"){search_order=a}showStatus("Searching...",false,function(){filterTimeoutProc=false;$("#book_form").css("display","none");$("#book_list").css("display","");var g=$("#book_search").val();if(search_query!=g){search_offset=0}search_query=g;if(g!=""){$("#book_list ul").html("");var c=g.split(" ");var d=[];for(var e in c){if(c[e].toLowerCase()!="and"&&c[e].length>=3){d.push(["authors","like","%"+c[e]+"%"]);d.push("OR")}}d.splice(-1,1);var f=[["title","like","%"+g+"%"],"OR",d];$.ajax({url:uri+"/books/searchBooks",type:"GET",dataType:"json",data:{query:g,select:["title","authors"],limit:25,offset:search_offset,order:search_order},async:true,success:function(h){procReturn(h);hideStatus()},error:function(h){showStatus("Finding Books failed.")}})}else{hideStatus();$("#book_list").css("display","none");$("#book_list ul").html("");$("#book_form").fadeIn();$("#book_left div.button2").fadeOut()}})}function toggleSearchResults(){var a=$("#book_list");if($(a).css("display")!="none"){$("#book_list").css("display","none");$("#show_search_results").html("Show Search Results")}else{$("#book_list").css("display","");$("#show_search_results").html("Hide Search Results")}}function assignBookReview(b,a,c,d){if(a){var e={id:a,cls:"BookReview",data:{}};if(c){e.data.journal_id=c}if(d){e.data.review_type_id=d}$.ajax({url:uri+"/svc/update",type:"POST",dataType:"json",data:e,async:true,success:function(f){if(f!=-1){showStatus("Book Review Assigned!")}else{showStatus("Error on saving book review.")}},error:function(f){showStatus("Error on saving book review.")}})}else{var e={cls:"BookReview",data:{book_id:b,journal_id:c,review_type_id:d}};$.ajax({url:uri+"/svc/create",type:"POST",dataType:"json",data:e,async:true,success:function(f){if(f!=-1){$("#book_review__"+f.book_id+"__book_review_id").val(f.book_review_id);showStatus("Book Review Assigned!")}else{showStatus("Creating Book Review Failed...")}},error:function(f){showStatus("Create Failed...")}})}}function addByISBN(ISBN){showStatus("Querying for Book...",false);$.ajax({url:uri+"/svc/bookByISBN",type:"POST",dataType:"json",data:{isbn:ISBN},async:true,success:function(ret){var book=ret.responseData.results[0];if(book){var res=$.ajax({url:uri+"/svc/read",type:"GET",async:false,dataType:"json",data:{cls:"BookMarketingInfo",query:[["isbn",book.ISBN]]}});eval("bookres = "+res.responseText);if(bookres.results.length!=0){alert("Sorry. Book Already Exists in Database");return}var res=$.ajax({url:uri+"/svc/create",type:"POST",dataType:"json",data:{cls:"BookMarketingInfo",data:{isbn:book.ISBN,pages:book.pageCount,thumbnail_url:book.tbUrl}},async:false});if(res!=-1){eval("bmi = "+res.responseText);var d=new Date();var res=$.ajax({url:uri+"/svc/create",type:"POST",dataType:"json",data:{cls:"Book",data:{title:book.title,authors:book.authors,year:book.publishedYear,date_added:Math.floor(new Date().getTime()/1000),synopsis:book.synopsis,publisher:book.publisher,book_marketing_info_id:bmi.book_marketing_info_id}},async:false});if(res!=-1){eval("res = "+res.responseText);showStatus("Book Created!");loadBook(res.book_id)}else{showStatus("Book Creation Failed.")}}else{showStatus("Book Creation Failed.")}}else{hideStatus();alert("No Books Found")}},error:function(ret){showStatus("Error on ISBN Search")}})};
